---
title: "New zeroes in the system"
author: "Sebastian Campbell"
date: "9 October 2015"
output: html_document
---

```{r knitr-settings, echo=FALSE}
#setwd("validation")
knitr::opts_chunk$set(echo = FALSE, comment = NA, results = 'hide')

ktable <- function(x){
  knitr::kable(x, digits = 2, format.args = list(big.mark = ",", zero.print = ".", scientific=FALSE))
}

perc_diff <- function(old, new){
  if (isTRUE(all.equal(old, 0))) {
    return(100)
  } else {
    (new - old) * 100 / old
  }
}

```

```{r setup}
library(faosws)
suppressMessages(library(faoswsUtil))
library(data.table)

GetTestEnvironment("https://hqlprswsas1.hq.un.fao.org:8181/sws", 
                   "ebdda55c-21a4-4bdd-9d0c-5098cec843f7")

#Read in results from old and new system
oldfile <- data.table(read.csv("oldfeedDemand.csv"))
newfile <- data.table(read.csv("newfeedDemand.csv"))

```


## Rationale

The Feed module was originally developed on the old system. As part of the process to move it to the new system, we compared the results under the old system with those under the new system. Most had the same results for protein and energy demand. A few had differences of less than 1%. The entries with larger differences are listed below. This table also includes percentage difference: `((old-new)*100/old`.

### Large differences in results

```{r}
#Declare keys
animalKeys <- fcl2cpc(sprintf("%04d", c(866, 946, 976, 1016, 1034, 1057, 1068, 1072, 1079, 1096,
                                        1107, 1110, 1126, 1140)))
stockKeys <- c("5111", "5112")
thousandHeads <- "5112"

```

```{r}
#Change column names and set keys
newfile[,geographicAreaM49 := as.character(geographicAreaM49)]
setnames(newfile, c("energyDemand", "proteinDemand"), c("newEnergy", "newProtein"))
setkey(newfile, geographicAreaM49, timePointYears)

oldfile[,geographicAreaFCL := fs2m49(as.character(geographicAreaFCL))]
setnames(oldfile, c("energyDemand", "proteinDemand"), c("oldEnergy", "oldProtein"))
setkey(oldfile, geographicAreaFCL, timePointYears)

#Merge old and new
mergetest <- newfile[oldfile]
# Add percentage differences
mergetest[, `:=`(energyPerc = perc_diff(oldEnergy, newEnergy),
                 proteinPerc = perc_diff(oldProtein, newProtein),
                 timePointYears = as.character(timePointYears))]
mergetest <- mergetest[,.(geographicAreaM49, timePointYears, oldEnergy, newEnergy,energyPerc, oldProtein, newProtein, proteinPerc)]

#get country names
keytranslations <- unique(mergetest$geographicAreaM49)
countrycodes <- GetCodeList("agriculture", "agriculture", "geographicAreaM49", keytranslations[!keytranslations %in% "532"])[,.(code, description)]
setnames(countrycodes, old=c("code", "description"), new=c("geographicAreaM49", "country"))
setkey(countrycodes, geographicAreaM49)

mergetest <- countrycodes[mergetest]

oldmerge <- mergetest[, .(oldEnergy, oldProtein)]
newmerge <- mergetest[,.(newEnergy, newProtein)]

#which rows are very different?
bigdiffs <- unique(which(abs(oldmerge - newmerge) > (0.01 * oldmerge), arr.ind = T)[,1])

#mergetest[diffrows,]
bigdiffs <- mergetest[bigdiffs,]
```

```{r, results='asis'}
ktable(bigdiffs)
```

## Which countries have the largest divergences?

To further split these up:

### Average difference % by country:

```{r results='show'}

ktable(bigdiffs[, .(energy=mean(energyPerc),
                    protein=mean(proteinPerc)), by=country][order(energy),])
```

### Average difference % by Year

```{r results='show', fig.width=5}
ktable(bigdiffs[ , .(energy=mean(energyPerc),
                    protein=mean(proteinPerc)), by=timePointYears][order(energy),])
```

## The raw data from those results

When fetching data from the SWS system to use in the module, the only data fetched was stock (in both heads and 1000 heads). The following are the values for stock from the old working system (oldValue) and SWS (Value) which correspond to the keys displayed above.

```{r}
# Set keys for merging
bigdiffkeys <- bigdiffs[, .(geographicAreaM49, country, timePointYears = as.character(timePointYears))]
setkey(bigdiffkeys, geographicAreaM49, timePointYears)

#Get CPC code names
CPCcodes <- GetCodeList("agriculture", "agriculture", "measuredItemCPC", animalKeys)[,.(code, description)]
setnames(CPCcodes, old = c("code", "description"), new = c("measuredItemCPC", "animal"))
setkey(CPCcodes, measuredItemCPC)


#Read in SWS data

key = DatasetKey(domain = "agriculture", dataset = "agriculture",
                  dimensions = list(
                    Dimension(name = "geographicAreaM49", keys = na.omit(fs2m49(as.character((1:299)[-22])))), #user input
                    Dimension(name = "measuredItemCPC", keys = animalKeys),
                    Dimension(name = "measuredElement", keys = stockKeys),
                    Dimension(name = "timePointYears", keys = as.character(1990:2012)) #user input
                    
                    )
                 )
animalHeads = GetData(key)[,timePointYears := as.character(timePointYears)]
setkey(animalHeads, geographicAreaM49, timePointYears)

```

```{r}
newdata <- merge(CPCcodes, animalHeads[bigdiffkeys], by="measuredItemCPC")
setkey(newdata, geographicAreaM49, measuredItemCPC, timePointYears)
```

```{r, message=FALSE}
source("../functions/sws_query.r")
olddata <- as.data.table(sws_query(area=1:299, item=c(866, 946, 976, 1016, 1034, 1057, 1068, 1072, 1079, 1096,
                                            1107, 1110, 1126, 1140 ), ele=11, year=1990:2012, value.names=F,
                                   class.path="../functions/ojdbc14.jar"))

olddata[,`:=`(area = fs2m49(as.character(area)),
           item = fcl2cpc(sprintf("%04d", item)),
           ele = NULL,
           year=as.character(year),
           flag = NULL)]
setnames(olddata, c("area", "item", "year", "value"), c("geographicAreaM49", "measuredItemCPC", "timePointYears", "oldValue"))
setkey(olddata, geographicAreaM49, measuredItemCPC, timePointYears)

raw_comparison <- olddata[newdata][, .(geographicAreaM49, country, measuredItemCPC, animal, timePointYears, oldValue, Value)]
raw_comparison <- raw_comparison[Value != oldValue,]
```

```{r, results='show'}
ktable(raw_comparison)
```

## Where are the zeroes?

The following tables are counts of which properties have the most zero values

### By country

```{r results='show'}
ktable(raw_comparison[, .(Zerocount=sum(Value == 0), Total=.N, Percent=sum(Value == 0)*100/.N), by = country][rev(order(Zerocount))])
```

### By animal

```{r results='show'}
ktable(raw_comparison[, .(Zerocount=sum(Value == 0), Total=.N, Percent=sum(Value == 0)*100/.N), by = animal][rev(order(Zerocount))])
```

### By year

```{r results='show'}
ktable(raw_comparison[, .(Zerocount=sum(Value == 0), Total=.N, Percent=sum(Value == 0)*100/.N), by = timePointYears][rev(order(Zerocount))])
```